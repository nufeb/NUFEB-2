%thesis.tex 
%Model LaTeX file for Ph.D. thesis at the 
%School of Mathematics, University of Edinburgh


\documentclass[11pt,a4paper,openright]{article}

%\usepackage{url,graphicx}

\usepackage{amsmath}
%\usepackage{natbib}
\usepackage{booktabs}
\usepackage{graphicx}
\usepackage{hyperref}%backref,
%\usepackage[dvips]{color}
\graphicspath{{expt/}}


\usepackage{times}
\usepackage[varg]{txfonts}

%%% Macro definitions for Commonly used symbols
\newcommand{\etas}{\ensuremath{\eta_{\mathrm{s}}}}
%\documentclass[a4paper, 11pt, draft]{Thesis} 

\usepackage{etex}
\usepackage{fixltx2e}
\usepackage{color,soul}
\include{Macros/MacroFile} % This file adds the macros for adding figures
  
% Include any extra LaTeX packages required
\usepackage[square, authoryear, colon, sort&compress]{natbib}  % Use the "Natbib" style for the references in the Bibliography
%\usepackage{verbatim}  % Needed for the "comment" environment to make LaTeX comments
\usepackage{vector}  % Allows "\bvec{}" and "\buvec{}" for "blackboard" style bold vectors in maths
\usepackage{float}
\usepackage{ifpdf}

%%% Some Fonts
\usepackage{textcomp}
\usepackage{pifont}% http://ctan.org/pkg/pifont
\usepackage{needspace}
\usepackage[noabbrev]{cleveref} %For crossreferencing

\usepackage{etoolbox}
\usepackage{float}

%%% For Changing fonts
%\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{charter}
%\usepackage[expert]{mathdesign}

%%% Packages for tables
\usepackage[usenames,dvipsnames,table]{xcolor}
\usepackage{hyperref}
\definecolor{red}{RGB}{255,50,50}
\definecolor{light_orange}{RGB}{253,245,230}
\definecolor{gray}{RGB}{225,225,225}
\usepackage{colortbl}% Allows shading of table cells
% Define a simple command to use at the start of a table row to make it have a shaded background
%\newcommand{\gray}{\rowcolor[gray]{.9}}

% % % Packages for TikZ setup for diagrams
%\usepackage[mode=buildnew]{standalone}
%%\standaloneconfig{mode=buildnew}
%\usepackage{tikz,pgfplots}
%\pgfplotsset{compat=newest}
%\usetikzlibrary{shapes,shapes.multipart,shapes.misc,shapes.geometric,arrows,shapes.symbols,shadows,shadows.blur}
%\usepackage{arydshln}
\usepackage{bm}
%\usepackage{tocbibind} 
%\renewcommand{\refname}{References}
%\renewcommand{\bibname}{References}

%:-------------------------- packages for fancy things -----------------------

%%% A (page...) to backref
\makeatletter
\patchcmd{\BR@backref}{\newblock}{\newblock(p.~}{}{}
\patchcmd{\BR@backref}{\par}{)\par}{}{}
\makeatother

%Make equation number label bold
\makeatletter
\let\mytagform@=\tagform@
\def\tagform@#1{\maketag@@@{\bfseries(\ignorespaces#1\unskip\@@italiccorr)}\hspace{3mm}}
\renewcommand{\eqref}[1]{\textup{\mytagform@{\ref{#1}}}}
\makeatother

%Fancy Chapter Heading style
%\usepackage[T1]{fontenc}
%\usepackage{titlesec, blindtext, color}
%\definecolor{gray75}{gray}{0.75}
%\newcommand{\hsp}{\hspace{20pt}}
%\titleformat{\chapter}[hang]{\Huge\bfseries}{\thechapter\hsp\textcolor{gray75}{|}\hsp}{0pt}{\Huge\bfseries}


%:-------------------------- packages for comments and notes -----------------------

\usepackage[colorinlistoftodos,shadow]{todonotes}
%%% Numbered ToDo Notes
\newcounter{todocounter}
\newcommand{\todonum}[2][]
{\stepcounter{todocounter}\todo[#1,size=\tiny]{\thetodocounter: #2}}

\newcommand{\hlfix}[2]{\texthl{#1}\todo{#2}}

\newcommand{\smalltodo}[2][]
{\todo[caption={#2}, author=PG, size=\footnotesize, #1]
{\begin{spacing}{0.5}#2\end{spacing}}}

%%% Word Style TODO Notes
\newcounter{mycomment}
\newcommand{\mycomment}[2][]{%
% initials of the author (optional) + note in the margin
\refstepcounter{mycomment}%
{%
\setstretch{0.7}% spacing
\todo[color={red!100!green!33},size=\tiny]{%
\textbf{Comment [\uppercase{#1}\themycomment]:}~#2}%
}}

%\includeonly{Chapters/C4} 

%% ================================
% PDF output options
\pdfminorversion=5
\pdfcompresslevel=9
\pdfobjcompresslevel=2
%% ================================

%% ----------------------------------------------------------------
%% End of Preamble
%% ----------------------------------------------------------------




\begin{document}
%
\title{Implementation of Individual Based (IB) Models within LAMMPS to model biofilm dynamics in a waste water treatment plant}
\author{Prashant Gupta, Curtis Madsen, Jayathilake Pahala Gedara}
%\date{14 Azad 1391}

\maketitle



\pagenumbering{roman}
\tableofcontents

\listoftables
\listoffigures


\cleardoublepage
\setcounter{page}{1}
\pagenumbering{arabic}

\section{Introduction}

The portable water shortage problem is widely discussed and demands a judicial usage of available resources. However, several countries (mostly under-developed and developing) suffer from extreme shortage of the water resources. Waste water treatment plants have served the societies for several decades now. Activated sludge process treatment plants are the most common types as it provides an advantage of better efficiency and economics.

\subsection{Activated Sludge process}

Activated sludge is defined as a microbial mass cultivated in order to break down the biomass into different components such as carbon dioxide, water and other nitrogen or phosphorous based compounds. Activated sludge process involves 3 different component mechanisms:

\begin{itemize}
\item A reactor in which the microbes are kept in suspension, aerated, and in contact with the waste they are treating.
\item Settlement of bulkier solid (activated sludge).
\item Recycling system for returning activated sludge back. 
\end{itemize}

In present waste water industries, many variants of activated sludge processes, primarily variations on how the activated sludge is recycled. Present study attempts to model following activated sludge process as described in the figure \ref{fig:ASP}.

\begin{figure}[!htb]
\begin{center}
  \includegraphics[width=0.75\columnwidth]{Figs/ASP.png}
\caption{Activated sludge process description for a waste water treatment plant (WWTP)}
\label{fig:ASP}       % Give a unique label
\end{center}
\end{figure} 


\subsection{Floc formation}
A floc is described as an aggregate of microbes bonded together by adhesive material (EPS) secreted by them. These clusters formations, often called as activated sludge, play a key role in the functioning of any waste water treatment plant (WWTP). Efficiency or the energy requirement of either of the primary and secondary tanks in an activated sludge process, depends upon the floc size, settlement or motility. Furthermore, the floc formation is governed by the microbial components adherence and cluster breakages.

\section{Individual based modelling (IBm)}
Pilot scale plants and laboratory scale experiments of WWTP are expensive, cumbersome, non-invasive and often can not provide information at the micro-scale, which is required for operational optimization of WWTP. Modelling of WWTP is challenging due to wide separation of temporal and spatial scales at which biological and physical processes key roles. Henceforth, a multi-scale modelling strategy is required to relate the microscopic microbial actions (often less than a micrometer size) to the macroscopic bulk WWTP operation (meter size scale). Identification of different length scales typical to a WWTP is presented can be shown in the figure \ref{fig:lscale}.  

\begin{figure}[!htb]
\begin{center}
  \includegraphics[width=0.5\columnwidth]{Figs/lengthscales.png}
\caption{Schematic of typical length scales for multi-scale modelling of a activated sludge process based Waste water treatment plant (WWTP)}
\label{fig:lscale}       % Give a unique label
\end{center}
\end{figure}  
 
\subsection{Introduction}
Discrete unit models such as the cellular automaton \citep{picioreanu1998mathematical} or the individual-based models \citep{kreft1998bacsim}, have been first developed and are now becoming widely applied to study effects of spatially multidimensional gradients in biofilms. Models which use individuals as a basic unit have occasionally been used in ecology since 1970s, but only since the visionary review of \citet{huston1988new} has individual-base modelling been an explicitly delineated approach of ecological modelling. Individual-based modelling refers in the following to simulation models that treat individuals as unique and discrete entities which have at least one property in addition to age that changes during the life cycle, e.g. weight, rank in a social hierarchy, etc. For biofilm modelling, \citet{kreft2001individual,picioreanu1998mathematical} initially proposed the Individual-based Modelling (IbM) as a proper tool compared with existing Cellular Automaton (CA) method used for biofilm modelling. In CA models, the biofilm is represented by collection of bricks, in which each brick is represented by a Cartesian grid (\citep{picioreanu1998mathematical,picioreanu1998new,picioreanu2000theoretical,eberl2000three}. In IbM, bacterial cells are represented as hard spheres, with each cell having, besides a variable volume and mass, a set of variable growth parameters, position, velocity, genotype etc. The IbM model consists of two parts: one deals with the growth and behaviour of individual bacteria as autonomous agents (i.e., biological processes); the other deals with the substrate and product diffusion and reaction and fluid flow (i.e., physical processes). Each cell grows by consuming the substrate and divides when a certain volume or mass is reached. The pressure build-up due to the growth of biomass is released by maintenance of a minimum distance between the neighbouring cells. In the traditional IbM approach, for each cell, the vector sum of all positive overlap radii with the neighbouring cells, which is called the shoving vector, is calculated and then the position of the cell is shifted in the direction opposite to this vector 3 sum. The substrate concentration is governed by a convection-diffusion-reaction equation and this transport equation is solved in a fixed Cartesian grid. Figure 1 shows the typical computation domain associated with IbM of biofilms. Basically it has three sub-domains each for biofilm, mass transfer boundary layer, and bulk fluid.

\subsection{Purpose of the model}

The model treats each microbes as individual entities interacting with each other and the surrounding environmental conditions. Various sub-models are employed for describing biology and physics at different length and temporal scales. 
The multi-physics/biological model developed can be used to investigate following key questions at different scales:

\begin{itemize}
\item Linking the microscopic (bacterium) to the mesoscopic (floc) to the macroscopic bulk operational parameters. 
\item Floc formation mechanism: How the microscopic phenomenon such as microbial growth kinetics, division, death, nutrient availability lead to microbial floc formation or breakage?
\item Effects of floc morphology and motility on the overall plant efficiency? 
\item How the hydrodynamics of the system can influence energy requirements of the WWTP?
\item Effect of the nutrient availability spatially and temporally?
\end{itemize}

\subsection{Model variables and principles}

The solver treats the microbes as spherical particles with EPS shells bounded on them. Fluid is treated as a continuum.
Nutrients are treated as concentrations in dissolved and convected through the flow fields. Given by their representations each components are solved accordingly. 

\begin{itemize}
\item Microbes: solved in a Lagragian framework. Each microbes is represented as a finite size sphere and has certain functionality. They are tracked throughout the simulations. The interactions between the microbes and with their ambient environment are complex and are described through different biological and physical sub-models described later. Following functional groups are considered: Heterotrophs (HET), Ammonia oxidizing bacteria (AOB), Nitrogen oxidizing bacteria (NOB), EPS particles and dead inert particles. 

\item Fluid: Fluid or the water phase is treated as a continuum media with microbes mostly suspended (neutrally buoyant). The fluid motion is solved in an Eulerian grid and takes into the account of the microbial suspension. Fluid and particle motion are tightly coupled by the hydrodynamics solver. 

\item Nutrients: The nutrients are treated as concentrations of the food supply in the water phase. The fluid solver supplies these nutrients to the microbes and hence contributes to their metabolism. Following nutrients relevant to the waste water treatment plant are taken into the account: Carbon substrates (S$_s$), Oxygen supply (O$_2$), Nitrates (NO$_{2}$), Nitrites (NO$_{3}$) and Ammonia (NH$_{4}$).
\end{itemize}

\subsection{IBm submodels}
Various cell level processes constitutes microbial working at cell level. Each of these processes can be termed as components of IBm model presented here. Modelling and fundamentals of each of these processes are presented here:

\subsubsection{Cell Growth}\label{growthmol}
Commonly found microbes in a WWTP can be grouped into functional group: Heterotrophs (HET), Ammonia oxidizing bacteria (AOB) and Nitrogen oxidizing bacteria (BOB). Each of the functional groups consume different nutrients and compete with each other for survival. Present tool allows a functional group and its function to be defined accordingly. Following equations give the reactions and their description is presented in a matrix form (\ref{fig:gdrates}):

\begin{equation}
\label{eq:GM}
\frac{dm_{i}}{dt} = Gm_{i}
\end{equation}

Each species has its own growth rate (G) and can be described according to the equation \ref{eq:GM12}. $\gamma_{HET} = 1$ and rest are zero, when solving for the HET equations. Same can be extended to AOB, NOB and EPS particles. $R_{j}$ (j=1-9) are given in the table \ref{fig:gdrates}.

\begin{equation}
\label{eq:GM12}
G = \gamma_{HET}\left ( R_1 + R_4 + R_5 \right )+\gamma_{AOB}\left ( R_2 \right ) + \gamma_{NOB}\left ( R_3\right ) -\gamma_{EPS}\left ( R_9\right )
\end{equation}

HET bound EPS growth rate is given by:
\begin{equation}
\label{eq:GMEPS}
G_{HET-EPS} = \frac{Y_{EPS}}{Y_{HET}} G m_{i}
\end{equation}

Reaction equations are primarily mass balance solved on the mesh discretization defined earlier. 

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.9\columnwidth]{Figs/Tableforrates.pdf}
\caption{Growth and decay rates for AOB, NOB, HET and EPS particles.}
\label{fig:gdrates}       % Give a unique label
\end{center}
\end{figure}  


Each of the components of uptake or consumption is calculated separately and added together following superposition principle. The rate is defined according to Monod-kinetics where the kinetics factors are product together. Also, the rate of the growth/decay is proportional to the instantaneous mass of the substrate. The local nutrient availability for the growth of each cell is based upon the ambient conditions solved through the passive scalar transport of the nutrients. Fluid-biofilm coupling solver ensures that each cell is aware of its ambient nutrient conditions.Each of the cell has nutrient availability concentration attributes as: Soluble substrate (S$_s$), Oxygen (O$_2$), NO$_2$, NO$_3$, NH$_4$. 

\subsubsection{Cell Division}\label{divisionmol}
Microbes can not grow forever (even with infinite food supply), division occurs due to sustenance of their sizes. Present model employs cell division rather empirically, by fixing up a maximum cell diameter, after which it divides. The model is implemented in following way: If the mass of a bacterial cell becomes greater than twice the mass of an inoculated individual bacterium, it divides into two daughter cells each. During the division process, the cell mass is split in a ratio randomly selected between 0.4-0.6. This generated two daughter cells from a parent cell. These daughter cells are oriented randomly around the centre of the parent cell. Figure \ref{fig:divcr} shows the division of daughter cells from the mother cell, randomly oriented around the centre of mother cell. This generation of newer particles occur at start of every time step and the forces equilibrated according to the overlaps, ensuring mechanical stability. The diameters of daughter cells are calculated using the cell mass and biomass density. Biomass density is constant for each species. 

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.6\columnwidth]{Figs/Divisioncrit.pdf}
\caption{Division of daughter cells from the mother cell, randomly oriented around the centre of mother cell}
\label{fig:divcr}       % Give a unique label
\end{center}
\end{figure}  


\subsubsection{Cell Death}\label{deathmol}
Microbial death is modelled as a random stochastic process. Every so often, a few microbes becomes biologically inactive i.e. they would not consume nutrient, grow or divide. These cells are treated as inactive particles by the solver and only participate in any physical/mechanical interactions with their neighbours. Depending on the total decay mass of HET, AOB, and NOB, the appropriate numbers of HET, AOB, and NOB cells are calculated and died. The mass of the dying cell shares between dead cell and carbon source. The mass of decaying EPS cells totally converts to carbon. Completely dissolved EPS particles are removed from the calculation. In the model this implemented by the total virtual dead mass of each species (HET or AOB or NOB) and is calculated from equations as below:

\begin{equation}
\label{eq:DR}
D = \gamma_{HET}R_{6} + \gamma_{AOB}R_{7} + \gamma_{NOB}R_{8}
\end{equation}

\begin{equation}
\label{eq:DR1}
M_{virtual} = \sum Dm
\end{equation}

where, D is the decay rate. At each time step (dt), number of cells equivalent to $M_{virtual}$ is set as dead (i.e. ID is changed to 5). These particles are randomly selected. When a cell is died, Y fraction of its mass remains in the dead cell and the other fraction (1-Y) is spontaneously converted to carbon substrate ($S_s$) and distributed to the Cartesian grid cell centre in which the particle resides. 

\subsubsection{EPS production and excretion}\label{EPSmol}
Microbes secrete extracellular polymeric substances (EPS) every so often as a waste product of their metabolic activities. EPS is secreted into their neighbouring environment and have known to lend structural integrity to the biofilms. Previous solvers have represented EPS in continuum and discrete manner. The solver works on the common knowledge that HETs excrete EPS, while AOB and NOB microbes do not. The present solver follows the iDynnomics approach of EPS treatment. Initially, EPS is accumulated as a extra shell beyond the HET particle (figure \ref{fig:EPScr}). It should be noted that the EPS density is much lower than the HET density. When the relative thickness of the EPS shell bound to HET particle exceeds a certain threshold value, almost half (random ratio between 0.4-0.6) of the EPS mass excretes as a separate EPS particle and positions next to the HET cell.

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.6\columnwidth]{Figs/EPScrit.pdf}
\caption{EPS bound to the the HET particle, extracted to an EPS particle according to the ratio between the EPS shell and the HET particle radius.}
\label{fig:EPScr}       % Give a unique label
\end{center}
\end{figure}  

\subsubsection{EPS-Adhesion forces}\label{adhmol}
The excreted EPS mass from the HET particles can be employed as a parameter of adhesion force models between the particles. The EPS link between the particles are treated as much more stiffer springs, but only employing the attractive forces. Total effective EPS mass is calculated between the microbes (Meps$_{e}$) and a spring stiffness is defined per unit mass (k$_{e}$). Effective overlap between the EPS links are calculated and the forces calculated according to the effective spring stiffness (Meps$_{e}$*k$_{e}$) multiplied by the overlap. This approach was first applied by Head et al. to reproduce a mechanically stable biofilm. 

\subsection{Physical models}

Present code employs physical modelling of 3 key aspects and coupling inbetween them: Microbes, fluid and nutrients. 
Microbes are treated as spherical motile living organisms interacting with themselves and with the ambient fluid. Physics of the microbial rheology is solved by using discrete element modelling (DEM). Fluid momentum and continuity equations are coupled with the particle solvers and solved together. Passive scalar transport equations of nutrient transport is solved along with the fluid equations. The field operational library OpenFOAM is used to construct upon a fluid solver, which is based on an existing TFM multiphase model there within \citep{rusche2003computational}. The Molecular Dynamics (MD) code LAMMPS is used to solve the DEM equations \citep{plimpton1995fast}. Some of the key features of the hybrid DEM-CFD code include:

\begin{itemize}
\item Open-source C++ based libraries providing an open architecture are coupled together using MPI libraries. 

\item BubbleFOAM, a TFM model based in OpenFOAM library \citep{rusche2003computational}, is modified to couple with the DEM equations. The solver employs the finite volume method for discretization. The momentum transfer terms are treated implicitly leading to an improved numerical stability. 

\item Passive scalar transport is solved with the fluid solver using \href{https://openfoamwiki.net/index.php/ScalarTransportFoam}{ScalarTransportFOAM}.

\item Unstructured meshes and complex geometries are within the capabilities of the OpenFOAM environment but not so straightforward in LAMMPS.

\item A soft sphere approach employing various visco-elastic contact models is used to resolve particle collisions with a highly efficient DEM solver.

\end{itemize}

\subsubsection{Fluid equations}
\label{sec:Fluid Equation}

The fluid velocity at each point in space is replaced by its average, taken over a spatial domain large enough to contain many particles but still small compared to the whole region occupied by the flowing mixture. The locally averaged incompressible continuity and momentum equations for the gas phase are given by \citep{anderson1967fluid, jackson1997locally}:

\begin{equation}
\label{eq:FluidContinuity}
\frac{\partial \epsilon} {\partial t} + \boldsymbol{\nabla} \cdot (\epsilon \mathbf{u}_{f}) =0 \text{,}
\end{equation}
and 
\begin{equation}
\label{eq:FluidMomentum}
\rho _{f} \frac{\partial \epsilon \mathbf{u}_{f}}{\partial t} +  \rho _{f} \nabla \cdot (\epsilon \mathbf{u}_{f} \mathbf{u}_{f})= - \boldsymbol{\nabla} P + \boldsymbol{\nabla} \cdot \tau _{f}+\epsilon\rho_{f}\mathbf{g} - \mathbf{I}_{f} \text{,}
\end{equation}
where $ \epsilon$ is porosity, $\mathbf{u}_{f}$, $P$, $ \rho_{f} $ and $\tau_{f} $ are the fluid velocity, pressure, density and viscous stress tensor, respectively; $\mathbf{g}$ is the gravitational acceleration;  and $\mathbf{I}_{f}$ is the inter-phase momentum transfer term arising due to fluid--particle interactions. 

The deviatoric stress tensor $\tau_{f}$ include the viscous stresses also. The porosity term $\epsilon$ is calculated from the microbial positions supplied by the DEM solver. An exact procedure for the porosity calculations will be presented at a later section. The fluid momentum equations are discretized and solved on an Eulerian grid by a finite volume method. The PISO solution procedure is followed to solve the fluid momentum equation and can be summarized as follows:

\begin{itemize}
\item Momentum prediction: solve the equation using the pressure field and the external forcing (like the interphase momentum term), available from the previous time step
\item Pressure solution: solve the pressure equation, and update the pressure field.
\item Velocity correction: correct the velocity field using the updated pressure field.
\item Repeat step 2 and 3 until convergence. 
\end{itemize}
 
The inter-phase momentum equation terms are treated semi-implicitly to improve numerical stability (details can be found at \citet{xiao2011algorithms}). The convection and diffusion terms are discretized with a blend of central difference (with second-order accuracy) and upwind difference (with first order accuracy), respectively. An implicit first-order Euler scheme is used for the time integration of the momentum equation.

\subsubsection{Discrete element method}
\label{sec:DEM}
The Newtonian equations of motion are solved for each particle in a Lagrangian framework \citep{cundall1979discrete}. The equations for the translational and rotational movement given by:

\begin{equation}
\label{eq:DEM_TranslationalEQ}
m_{i}\frac{d}{dt}\mathbf{v}_i =\mathbf{f}_{\mathrm{c}i} + \mathbf{f}_{\mathrm{fp}i} + m_i \mathbf{g} + \mathbf{f}_{\mathrm{vdw}i}
\end{equation}


The total force acting on a microbe is calculated as the sum of total contact, adhesion, gravitational and fluid interaction forces. The contact force ($\mathbf{f}_c$) is calculated as a sum of all the forces due to interaction with neighbouring microbes. The adhesive force ($\mathbf{f}_{adh}$) is calculated as a sum of all pair-wise adhesive interaction due to the EPS. The fluid-particle interaction force ($\mathbf{f}_\mathrm{fp}$) is obtained from a drag model, which is based on coarse grained fluid and particle variables. 

Following steps are enlisted to solve the dynamics of microbial motion by the DEM equations:

\begin{itemize}
\item Neighbour list building: Identify the neighbouring microbes that are in actual contact or in the vicinity of the EPS  sphere of influence, using the microbial positions information.
\item Contact Model: Calculate the forces due to the inter-microbial collisions and the energy dissipation due to the frictional and viscous damping. 
\item Adhesion Model: Calculate the adhesive forces resulting from EPS interactions.
\item Time-step calculations: Estimate the microbial interaction time-step based on the contact model employed and its parameters. 
\item Drag Model: Calculate the fluid-particle interaction force from the coarse-grained quantities. These calculations are done at the fluid time step which is much greater than the microbial interaction time step. 
\item Time integration: Evolve the microbial positions and velocities to the next time-step using the forces calculated from above steps. 
\end{itemize}

These steps would be briefly discussed in following subsections. A detailed explanation and implementation of each step can be found at \citet{plimpton2005lammps}.

\subsubsection{Neighbour lists}
DEM time-step is typically of the order of $10^{-7}$ s. In order to calculate the forces by contact models on each microbes, one has to loop over each particle twice per time step. This makes the DEM computations very expensive. The computational load can be reduced by maintaining neighbour lists to keep a track of only the neighbouring particles of each particles in the system.  Efforts are done to minimize the neighbour list size without omitting any force pair: contact or cohesion. In literature, three such algorithms are employed to the build neighbour lists:

\begin{itemize}
\item Verlet Neighbour List (VNL): A maximum search radius is supplied as an input parameter, which is more than the cohesion influence of sphere. This radius is decided by: (1) the dynamics of the system (2) the particle time-step. A lower search radius can decrease computational times drastically, but there is a risk of omitting some force pairs. A conservative search radius would be around 2-2.5 times diameter of the average particle size in the domain. It should be noted that the neighbour list is updated only so often and not at every particle time step.

\item Link Cells: The simulation domain is divided into a number of sub-domains with a bin size around 2-3 diameter of particle. A list of all the particles is maintained for every sub-domain and the contacts are only checked within the sub-domain. Computational costs of this method is slightly more than the VNL method due to extra costs associated with keeping a track of all the contacts across the boundaries. However, this algorithm can be employed more efficiently if the code is parallelized. LAMMPS employs a link cell algorithm for contact detection. 

\item Lattices: Lattice points are defined within the domain. Each particle is indexed in relation to a lattice point and a neighbour list is created for all cells within a particle diameter $d$. 
\end{itemize}


\subsubsection{Collision model}
 
Contact models are used to determine forces on the particles based on the particle's colliding velocities and material properties. Consider two contacting particles ($i$, $j$), with radii ({$a_i$, $a_j$}), at positions ($\mathbf{r}_i$, $\mathbf{r}_j$), with velocities ($\mathbf{v}_i$, $\mathbf{v}_j$) and angular velocities {$\bm{\omega}_i$, $\bm{\omega}_j$}. 

 \begin{figure}[!htb]
\begin{center}
  \includegraphics[width=0.4\columnwidth]{Figs/contactingpart.pdf}
\caption{Schematic of two particles $i$ and $j$ in contact and position vectors $\mathbf{r}_i$, $\mathbf{r}_j$, respectively, with overlap $\delta_{ij}$. Resultant normal and tangential forces acting on each particle are shown here.}
\label{fig:chp2a1}       % Give a unique label
\end{center}
\end{figure}  

The normal compression $\delta_{ij}$, relative normal velocity $\mathbf{v}_{\mathrm{n}_{ij}}$, and relative tangential velocity $\mathbf{v}_{\mathrm{t}_{ij}}$ can be given as follows:

\begin{equation}
		\delta_{ij}=d - r_{ij}\text{,}
\end{equation}
	%
\begin{equation}
		\mathbf{v}_{\mathrm{n}_{ij}}=(\mathbf{v}_{ij}\cdot \mathbf{n}_{ij})\mathbf{n}_{ij}\text{,}
\end{equation}
	%
\begin{equation}
\mathbf{v}_{\mathrm{t}_{ij}}=\mathbf{v}_{ij} - \mathbf{v}_{n_{ij}} -(a_i\bm{\omega}_i + a_j\bm{\omega}_j)\times \mathbf{n}_{ij}\text{,}
\end{equation}
	where $d = a_i + a_j$, $\mathbf{r}_{ij}= \mathbf{r}_i -
        \mathbf{r}_j$, $\mathbf{n}_{ij} = \mathbf{r}_{ij}/r_{ij}$,
        with $r_{ij} = |{\mathbf{r}_{ij}}|$ and $\mathbf{v}_{ij} =
        \mathbf{v}_i - \mathbf{v}_j$. The rate of change of the
		elastic tangential displacement $\mathbf{u}_{\mathrm{t}_{ij}}$, set to
        zero at the initiation of a contact is:
	%
	\begin{equation}
		\label{eqn-ut}
		\frac{\mathrm{d}\mathbf{u}_{\mathrm{t}_{ij}}}{\mathrm{d}t} = \mathbf{v}_{\mathrm{t}_{ij}}
		- \frac{(\mathbf{u}_{\mathrm{t}_{ij}}\cdot\mathbf{v}_{ij})\mathbf{r}_{ij}}{r^2_{ij}}\text{.}
	\end{equation}
	
	
The last term in equation~\eqref{eqn-ut} arise from the rigid body rotation around the contact point and ensures that $\mathbf{u}_{\mathrm{t}_{ij}}$ always lies in the local tangent plane of contact. Popular contact models that are employed in the literature are a combination of spring, slider and a dash-pot. This assembly is used to estimate the normal and tangential contact forces \citep{cundall1979discrete}. The capability of the model to capture collisional behaviour depends upon the force-displacement ($\mathbf{F}_{\mathrm{n}_{ij}}-\delta_{ij}$) relationships. A brief listing of different contact models is provided here. For a more comprehensive details on each model, readers are referred to LAMMPS user manual \citep{plimpton2005lammps}. 

\begin{itemize}
\item Cohesion-less normal contact models:  Common examples of these are linear spring dash-pot (first used by \citet{cundall1979discrete}). Hertz-midillin contact model \citep{tsuji1992lagrangian}, hysteretic spring models that dissipates energy \citep{walton1986viscosity} and models accounting for plastic deformations \citep{thornton1997coefficient}.  

\item Elastic adhesive contact models: These model include effect of adhesive forces to simulate fine powders. Commonly used models are JKR \citep{johnson1971surface}, DMT \citep{derjaguin1980different} and models accounting for both adhesion and plasticity \citep{thornton1998theoretical},\citep{luding2008cohesive},\citep{thakur2014micromechanical}.   
\end{itemize}

In the present work, a linear spring-dashpot model is employed for the contact force model with the static friction between the microbes, modelled according to the Coulomb's law (given below). 

	\begin{equation}
		\mathbf{F}_{\mathrm{n}_{ij}} = f(\delta_{ij}/d)(k_{\mathrm{n}}\delta_{ij}\mathbf{n}_{ij} 
		- \gamma_{\mathrm{n}} m_{\mathrm{eff}}\mathbf{v}_{\mathrm{n}_{ij}})\text{,}
	\end{equation}
	%
	\begin{equation}
		\mathbf{F}_{\mathrm{t}_{ij}} = f(\delta_{ij}/d)(-k_{\mathrm{t}}\mathbf{u}_{\mathrm{t}_{ij}} 
		- \gamma_{\mathrm{t}}m_{\mathrm{eff}}\mathbf{v}_{\mathrm{t}_{ij}})\text{,}
	\end{equation}
	where $k_{\mathrm{n,t}}$ and $\gamma_{\mathrm{n,t}}$ are the spring stiffness
        and viscoelastic constants, respectively, and
        $m_{\mathrm{eff}} =m_im_j /(m_i + m_j)$ is the effective mass
        of spheres with masses $m_i$ and $m_j$. The corresponding
        contact force on particle $j$ is simply given by Newton's
        third law, i.e., $\mathbf{F}_{ji} = -\mathbf{F}_{ij}$. The
        function $f(\delta_{ij}/d)=1$ is for the linear spring-dashpot
        model, and $f(\delta_{ij}/d)=\sqrt{\delta_{ij}/d}$ is for
        Hertzian contacts with viscoelastic damping between spheres.



\subsubsection{Interphase momentum transfer}
\label{sec:Momentum}

The coupling between the gas phase and particle motion is implemented through a volume averaged fluid--particle interaction term ($\mathbf{I}_{\mathrm f}$) in the gas momentum equation. According to the Newton's third law, negative of a similar term is added to the particle equation of motion ($\mathbf{f}_{\mathrm{fp}i}$):

\begin{equation}
	\label{eq:fpinteract}
\mathbf{f}_{\mathrm{fp}i} = - V_{\mathrm{p}i} \boldsymbol{\nabla} p    + \frac{\beta_i V_{\mathrm{p}i} }{\phi}\left ( \mathbf{u}_{\mathrm{f}i} -\mathbf{v}_{i}\right )  \text{,}
\end{equation}

Here $V_{\mathrm{p}i}$ is the volume of particle $i$; $\phi = (1 -\epsilon)$ is the solid volume fraction; $\mathbf{u}_{\mathrm{f}i}$ is the fluid velocity extrapolated to the particle $i$ position and $\beta_i$ is the particle based drag coefficient. The total interaction $\mathbf{I}_{f}$ in a fluid cell is calculated by adding all particle--fluid interaction forces in the cell as 
\begin{equation}
\mathbf{I}_{f} = \frac{1}{V_{\mathrm{cell}}}\sum_{i=1}^{n}\mathbf{f}_{\mathrm{fp}i} W_i \text{,}
\end{equation}
where $V_{\mathrm{cell}}$ is the volume of the fluid cell and $W$ is the weighting function accounting for the contribution of a particle. The weights are calculated according to a Box-car or a Gaussian function \citep{xiao2011algorithms}. The drag force is first calculated on each individual particle and then volume averaged to give it back to the fluid cell. In order to calculate $\beta_i$, many different correlations derived in limited conditions are employed in ad-hoc ways, to dynamic conditions present in a fluidized bed.

\subsubsection{Drag model closures \label{sec:Drag}}

The drag coefficient used in the Eq.~\ref{eq:fpinteract} can be written as
\begin{equation}
\label{eq:Fbeta}
\beta = 18 \mu \phi (1-\phi)\frac{F}{d^2} \text{,}
\end{equation}
where $F$ is the drag force, non-dimensionalized by the Stokes--Einstein drag force  ($3 \pi \mu d \left ( \mathbf{u}_{\mathrm{f}i} -\mathbf{v}_{i} \right ) (1-\phi) $); and $\mu$ is the fluid viscosity. This dimensionless drag force can be expressed as a function of solid fraction ($\phi$) and the particle Reynolds number ($Re = \epsilon \rho_{f}d_{i} \left | \mathbf{u}_{\mathrm{f}i} -v_{i} \right | / \mu$), for a particle of diameter $d$.


\subsubsection{Drag models}

Drag models correlations were traditionally deduced from the experiments \citep{ergun1952fluid,wen1966generalized,di1994voidage}:

\begin{itemize}
\item Measuring pressure drop across a fixed bed \citep{ergun1952fluid}, fluidized with different inlet fluid velocities. The pressure drop was related to the particle and fluid properties along with the operational conditions.  
\item Sedimentation of small particles in a very dilute regime \citep{richardson1954sedimentation} and correlating the drag forces to the terminal velocity and voidage function (form $\epsilon^{n}$).
\item \citet{wen1966generalized} used experimental data of \citet{richardson1954sedimentation} and correlated drag forces by a different function with a slightly better fit. 
\item Sedimentation of mono-disperse particles in a dense phase regime \citep{di1994voidage}, and introducing an explicit function of voidage to take into account of restricted flow around many particles.
\end{itemize}

For a list of more drag models, readers are referred to the fluidization hand book by \citet{yang2003handbook}. A combinations of these drag models also been used to cover a wide range of solid fractions and flow conditions found in a fluidized bed. The most popular of these models are by \citet{gidaspow1994multiphase} which combines the \citet{ergun1952fluid} and the \citet{wen1966generalized} drag models, given by equation \ref{eq:ErgWenYu}. 

\begin{equation}
\label{eq:ErgWenYu}
F_{\mathrm{EWY}}(\phi,Re) = \begin{cases} 
(1+ 0.15Re^{0.687})(1-\phi)^{-3.65} &\,
 \phi \leq 0.2 \\ 
\frac{150}{18}\frac{\phi}{(1-\phi)^2}  + \frac{1.75}{18}\frac{Re}{(1-\phi)^2} &\, \phi > 0.2 
\end{cases} \text{,}
\end{equation} 

Modifications to the \citet{richardson1954sedimentation} correlations were done by \citet{syamlal1987generalized} to get a better drag model applicable at high solid fractions and extended to cover particle Re numbers upto 10. To account for non-spherical particles, drag coefficient expression was developed by Haider and Levenspiel~\cite{haider1989drag}, based on the \citet{di1994voidage} equations: 

\begin{align}
\label{eq:DiFelicea}
% F_{\mathrm{HL}} (\phi,Re) =\frac{1}{24} C_D Re (1-\phi)^{-\chi }
F_{\mathrm{HL}} (\phi,Re) & = \left [ (1+A(Re)^B) + \frac{C}{1+\frac{D}{Re}} \right ] (1-\phi)^{-\chi } \text{,} \\ 
\text{where} &  \nonumber \\
\chi &= 4.7 - 0.65 \exp({-(1.5-\log_{10}Re)^2/2})\text{,} \nonumber\\ 
A &= \exp(2.3288-6.4581\alpha + 2.4486\alpha^2) \text{,}  \nonumber\\ 
B &= 0.0964 + 0.5565\alpha   \text{,}   \nonumber\\
C &= \exp(4.905 -13.8944\alpha + 18.4222\alpha^2 -10.2599\alpha^3) \text{,}  \nonumber \\
D &= \exp(1.4681+12.2584\alpha-20.7322\alpha^2 + 15.8855\alpha^3) \text{,}  \nonumber
\end{align}

$\alpha$ is the particle sphericity which is defined as the ratio of the surface areas between a spherical particle with an equivalent volume and the irregular particle. 

\subsubsection{Algorithm for inter-phase momentum exchange}
The overall algorithm for fluid-particle interaction used in the open-source DEM-CFD code can be summed up in the following way manner:

\begin{enumerate}
\item Calculate the inter-phase momentum term from the previous time step velocity fields ($u_{f}^{n-1}$, $P_{f}^{n-1}$).
\item Substitute the drag terms in the momentum equation and solve iteratively the momentum equation using PISO alogithm described earlier. Update the pressure and velocities field to current time step: ($u_{f}^{n-1}$, $P_{f}^{n-1}$) to ($u_{f}^n$, $P_{f}^n$) 
\item Calculate the inter-phase momentum term based on ($u_{f}^n$, $P_{f}^n$).
\item Compute the fluid particle drag on each particle based on ($u_{f}^n$, $P_{f}^n$) and evolve particle position using DEM simulator.
\item Obtain the voidage ($\epsilon$) and the coarse grained particle velocity fields via averaging from DEM particle positions and velocity. 
\item Give these field back to the fluid momentum equation as an input for (n+1) time step.
\end{enumerate}


\subsubsection{Numerical methods \label{sec:TMS}}
DEM-CFD code works on two time scales: (1) inter-particle (2) fluid-particle interaction. Inter-particle contact time for the collisions is estimated from the contact force model employed. For a linear spring dash-pot model, a maximum contact time can be calculated in terms of spring coefficient, effective mass of particles, and the damping coefficient for collision between the particles $m$ and $n$ (equation \ref{eq:Contacttime}). The time step for DEM integration is typically kept fairly low, around 2\% of the contact time. For fluid-particle interaction, the particle relaxation times $\tau_{p}$ is used to quantify the time scales of the interactions. For a stationary particle released in a fluid, relaxation times can be calculated with a constant slip velocity assumption (defined as $u_{ri} = u_{pi}-u_{fi}$) by the equation \ref{eq:relaxationtime}.

 \begin{equation}
 \label{eq:Contacttime}
 t_{mn}^{col} = \pi\left ( \frac{k_{mn}}{m_{e}} - \frac{\eta_{mn}^{2}}{4m_{e}}\right )^{-1/2}
 \end{equation}

 \begin{equation}
 \label{eq:relaxationtime}
 \tau_{p} = \frac{U_{e}m_{i}}{\epsilon_{f} f_{di}}
 \end{equation}

where $\epsilon_{f}$ is the void fraction; $f_{di}$ is the drag force acting on particle; $U_{e}$ is the slip velocity and $m_{i}$ is the mass of the particle $i$. Another important consideration for the fluid time step is the Courant-Friedrichs-Lewy (CFL) conditions based upon the mesh size employed \citep{xiao2011algorithms}. Particle time steps are decided by the minimum of the two time scales, whereas fluid time step is decided by the CFL conditions. Furthermore, turbulent length scales can be important especially in case of high Re number and lean phase cases such as pneumatic conveying \cite{sommerfeld2003analysis}. $\tau_p$ and $t_{mn}^{col}$ governs the fluid and particle time steps. For gas-solid interactions, the particle time steps are 2-3 order of magnitude more than the fluid time steps. 


\subsection{Stochastic processes: Scope of improvement}
Different processes are modelled by the sub-models as stochastic processes. This adds variability and randomness to the biological process, typically evident in the nature. Following processes are random:

\begin{itemize}
\item Initialization of the system by placing the microbes with random physical and biological attributes are placed at random locations within the domain. This introduces the randomness of the initial configuration. 

\item Cell division criterion is based on a critical random maximum ratio, which can be selected by the user. Solver further divides the daughter cell masses randomly in a ratio between 0.4-0.6 placing daughter cells in a random orientation. 

\item During the death sub-model, microbes equivalent to the dead-mass are randomly chosen by the solver. 

\item EPS excretion occurs after the shell bound EPS exceeds a randomly selected value by the user. This excreted EPS is oriented and placed randomly around the mother cell. 

\end{itemize}

As recommended by the iDynomics solver, these processes can be tackled from a microscopic point of view with fundamental chemical and biological processes driving these mechanisms.   

%\subsection{Modelling bio-film dynamics and response to the fluid flow}
%\begin{itemize}
%\item Physical processes in a activated sludge process. 
%\item Typical forces acting on a bio-particle. 
%\item how to model them. 
%\item Hydrodynamics of the system. 
%\end{itemize}
%
\section{LAMMPS}
\subsection{Introduction to LAMMPS}
LAMMPS is a classical molecular dynamics code developed at Sandia labs and primarily built to solve the particle physics including wide range of inter-particle interactions and potentials. The code treats each particle as an individual discrete unit, much similar to the popular IB approach. Sandia Labs distributes LAMMPS under the terms of the GNU Public License (http://lammps.sandia.gov/). The current version of the code is written in C++ with an open architecture and provides an opportunity to couple with other open-source codes. LAMMPS can run efficiently in both serial and parallel versions depending upon the computational facilities available to the users.  The LAMMPS code is designed to modify and extend it with newer capabilities as desired by the user. While only 25\% of the 140K line code in LAMMPS forms the core of the solver, rest of the code is contributed by a large user database across the globe in order to extend its capabilities. An overview can of current LAMMPS capabilities can be found at \href{http://lammps.sandia.gov/features.html}{LAMMPS-feature}.

\subsection{LAMMPS working methodology}
LAMMPS solves the motion of every single particle by simply integrating Newton's equations of motion in response to sum of the forces (short or long range based on their interaction with neighbours). At a particular time instance, motion of each particle is collectively solved when subjected to initial or boundary conditions. In order to maintain computational tractability while calculating the interaction forces, LAMMPS maintains a neighbourhood list for each particle which gets updated every so often. These lists are optimized so that local densities and particle overlaps never becomes non-physical. For parallel simulations, LAMMPS spatially partition the domain into smaller sub-domains assigned to each processors. Interprocessor communications are maintained by storing ghost atom interactions with the sub-domain boundaries. LAMMPS development can be helped by two user manuals: User manual and developer manual. The following links will be helpful for the users to get started on LAMMPS:

\begin{enumerate}
\item User manual: \url{http://lammps.sandia.gov/doc/Manual.pdf}
\item Developers guide: \url{http://lammps.sandia.gov/doc/Developer.pdf}
\item Tutorials: \url{http://lammps.sandia.gov/tutorials.html}
\item Commands: \url{http://lammps.sandia.gov/doc/Section_commands.html}
\item Features: \url{http://lammps.sandia.gov/features.html}
\end{enumerate}

%A further overview on LAMMPS can be taken from: $http://lammps.sandia.gov/tutorials/italy14/italy_overview_Mar14.pdf$
In the present study, LAMMPS-Feb14 version is developed and newer IB features and capabilities added, this version will be now on referred as LAMMPS-NCL. 

\subsection{Operating systems}
In general, LAMMPS can be run on Windows, Linux, Mac OS using pre-built executables. LAMMPS-NCL can be compiled with almost any linux or Mac OS (instructions in the user manual). It is emphasized that present NCL version has been rigorously tested on Ubuntun-14.10 and Fedora-22. In near future, prebuilt executables,binaries or RPMS will be provided to be used on any OS.

\subsection{Pre-compilation instructions}

Before compiling LAMMPS, please make sure you are installed with these packages depending upon the operating system used:

\begin{itemize}
\item fftw (http://www.fftw.org/doc/Installation-on-Unix.html)
\item openmpi (http://www.open-mpi.org/)
\item libjpegm (http://libjpeg-turbo.virtualgl.org/)
\item gcc/g++ (https://help.ubuntu.com/community/InstallingCompilers)
\end{itemize} 

\section{LAMMPS-NCL and getting started}
For the pre-existing LAMMPS commands, features and documentation, please refer to the LAMMPS user manual, listed above. The manual covers extensive instructions on compiling LAMMPS and how to get started.LAMMPS-NCL is compiled the same way as you would compile LAMMPS and there is no change in those instructions. The newer capabilities and commands will be highlighted and emphasized in the next sections and the sample input script. 


\subsection{Downloading LAMMPS-NCL}
In general, different versions of LAMMPS can be downloaded from the \href{http://lammps.sandia.gov/download.html}{download section} of the LAMMPS website. For the present study, LAMMPS version Feb 2014 was developed and enhanced with biological IB model capabilities. It is advised to use the version developed at NCL. It can be downloaded using following set of instructions from the \href{https://github.com/darrenjw/nufeb/tree/master/code/lammps1Feb2014}{NUFEB Github repository}.
 

\subsection{LAMMPS extension}
In the present study, capabilities of LAMMPS have been extended to include cell level biological processes such as cell growth, division, maintenance, death etc. These extended capabilities involve addition of newer particles at each time-steps e.g. during a cell division: a single parent cell divide into two daughter cells. A summary of list of newer capabilities added to the LAMMPS and its implementation is presented here:


\subsection{Atom type}
Classical LAMMPS provide different atom types that could be used by user. These are specified in the input script by the command: \href{http://lammps.sandia.gov/doc/atom_style.html}{atom$_{style}$}. \href{http://lammps.sandia.gov/doc/atom_style.html}{$atom-style$} command must be used before a simulation is setup via a \href{http://lammps.sandia.gov/doc/read_data.html}{read-data}, \href{http://lammps.sandia.gov/doc/read_restart.html}{read-restart} or \href{http://lammps.sandia.gov/doc/create_box.html}{create-box} command. A newer atom$_{style}$ is added (named "bio") to increase the number of attributes such as nutrients available to each microbe type. The new atom$_{style}$ is inherited from already existing $atom-style$ sphere. Though LAMMPS provides another route for adding newer attributes through \href{http://lammps.sandia.gov/doc/fix_property_atom.html}{fix property/atom}. However, since the newer attributes would be used to couple with the fluid solver, they should be more tightly linked to the atom style. 

The new atom type "Bio" have following attributes in conjunction to the sphere type: ID, type, radius, outer-radius, mass, outer-mass,x,y,z, S$_s$, O$_2$, N$O_3$, N$O_2$, N$H_4$. As a general rules following types are assigned to the functional groups. 

\begin{itemize}
\item 1-HET 
\item 2-AOB
\item 3-NOB
\item 4-EPS
\item 5-Inert
\end{itemize} 

Each microbe has unique moniker ID but share its type according to the functional group. Physical parameters such as initial radius, outer radius, density and outer density can be mentioned. Radius and density are the radius and density of the microbe. Outer radius and densities are the initial EPS-shell bound radius and densities. Density is constant throughout the simulation and time invariant. However radius and mass (calculated from density and radius) can change. EPS is only bound to the HET particles (type 1), hence outer radius should be specified as radius for other particle types initially. LAMMPS will give an error message if this is not followed. For LAMMPS book-keeping, inner radius is always same as outer-radius for other types than 1 throughout the simulation. Initial configuration can be either generated randomly through LAMMPS or by the user. Caution must be taken to avoid overlaps when defined by the user. A typical user input script is included in the folder (IC5nut.in). 

Different sub-models are coded within LAMMPS in a modular way. Each of these models, implementations and command lines are explained in the following sub-sections.


\section{Input script generated for the NUFEB-Bio simulations}
In order to execute LAMMPS commands, an input script is usually prepared with certain sub-commands and parameters list. 
Figure \ref{fig:inputscript} gives the input script for the NUFEB project. This script can be generated by GUI and will be explained later. New additions to the LAMMPS commands are pointed in the boxes as shown in the figure. 

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.9\columnwidth]{Figs/Inputscript.pdf}
\caption{Input script for NUFEB simulation of biofilm dynamics.}
\label{fig:inputscript}       % Give a unique label
\end{center}
\end{figure}  


\subsection{Cell growth}
Cell growth model described in the section \ref{growthmol} is implemented as a fix type "growth" in the LAMMPS, the source code can be found in the src folder of the LAMMPS directory. In the present implementation, GUI will help to generate LAMMPS command line for the fix growth and user just have to make sure to put in correct parameters. GUI is described later. Figure \ref{fig:growth} gives the LAMMPS command line for the growth model.

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.98\columnwidth]{Figs/growthfix.pdf}
\caption{Command line for the growth fix in LAMMPS}
\label{fig:growth}       % Give a unique label
\end{center}
\end{figure}
 
In total, 20 parameters are given for the growth fix command. Specifically, "fix g1 all nugrowth 1" means invoke a fix nugrowth instance named g1 and apply it at everytimestep (1 = frequency of call) to "all" the particle types in the assembly. The second parameter "all" indicates that all the microbes can grow. Any other microbial type could also be mentioned, which would indicate that growth only occurs only for that specific type. All of the parameters has to be in SI units. A table of the typical parameters can be seen at the end of the documentation. The parameter description:

\begin{itemize}
\item fixID: unique ID of the fix (not used in the script before)
\item group: Functional groups on which fix will be invoked, it can take: HET, AOB, NOB, all.
\item fix-name: nugrowth (fix name). It can not take another value.
\item freq: frequency at which the fix is invoked (typically at every timestep). Values has to be integers.
\item KsHET Ko2HET Kno2HET Kno3HET Knh4AOB Ko2AOB Kno2NOB Ko2NOB: Affinity of all the functional groups to the substrate.
\item MumHET MumAOB MumNOB: Monod kinetic parameters for the HET, AOB and NOB.
\item etaHET: Reduction factor in anoxic conditions for HET.
\item bEPS: Decay rate of EPS.
\item YEPS, YHET: Yield coefficient for EPS and HET particles.
\item EPS-density: Density of the EPS, required for the divisions of HET particles. Values can be floating type number.
\end{itemize}


\subsection{Cell Division}
Cell division model described in the section \ref{divisionmol} is implemented as a fix type "division" in the LAMMPS, the source code can be found in the src folder of the LAMMPS directory. The command line is given in the figure \ref{fig:division}:

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.6\columnwidth]{Figs/divisionfix.pdf}
\caption{Command line for the division fix in LAMMPS}
\label{fig:division}       % Give a unique label
\end{center}
\end{figure}

The command line follows the template: "fix fixID group fix-name freq EPS-density Ratio seed". The parameter description:
\begin{itemize}
\item fixID: unique ID of the fix (not used in the script before)
\item group: Functional groups on which fix will be invoked, it can take: HET, AOB, NOB, all.
\item fix-name: divide (fix name). It can not take another value.
\item freq: frequency at which the fix is invoked (typically at every timestep). Values has to be integers.
\item EPS-density: Density of the EPS, required for the divisions of HET particles. Values can be floating type number.
\item Ratio: User defined diameter ratio at which the division takes place. The ratio is calculated as the instantaneous diameter divided by the average diameter of the microbes. The average diameter is initially defined and hard coded. The values have been indicated in the earlier sections. Values typically floating type number greater than 1.0.
\item Seed: Seed for the orientation and introduce the randomness, very large integer values. Same seed will result in the same orientation for every simulation run. 
\end{itemize}

\subsection{Cell Death}
Cell death model described in the section \ref{deathmol} is implemented as a fix type "death" in the LAMMPS, the source code can be found in the src folder of the LAMMPS directory. Figure \ref{fig:death} gives the specific command lines.

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.6\columnwidth]{Figs/deathfix.pdf}
\caption{Command line for the death fix in LAMMPS}
\label{fig:death}       % Give a unique label
\end{center}
\end{figure}

The command line follows the template: "fix fix-ID group fix-name freq decay-rate ratio seed". The parameter description:
\begin{itemize}
\item fixID: unique ID of the fix (not used in the script before)
\item group: Functional groups on which fix will be invoked, it can take: HET, AOB, NOB, all.
\item fix-name: death (fix name). It can not take another value.
\item freq: frequency at which the fix is invoked (typically at every timestep). Values has to be integers.
\item decay-rate: Rate of decay, according to the type of microbe.
\item Ratio: Death ratio, described earlier in the model, typically floating number greater than 1.0.
\item Seed: Seed for randomly choosing particles to kill. 
\end{itemize}

\subsection{EPS extract}
EPS extraction model described in the section \ref{EPSmol} implemented as a fix type "EPS extract" in the LAMMPS, the source code can be found in the src folder of the LAMMPS directory. Figure \ref{fig:EPS} gives the specific command lines.

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.6\columnwidth]{Figs/EPSfix.pdf}
\caption{Command line for the EPS extract fix in LAMMPS}
\label{fig:EPS}       % Give a unique label
\end{center}
\end{figure}

The command line follows the template: "fix fix-ID group epsextract freq EPSratio EPSdens seed". The parameter description:
\begin{itemize}
\item fixID: unique ID of the fix (not used in the script before)
\item group: Functional groups on which fix will be invoked, it can take: HET, AOB, NOB, all.
\item fix-name: death (fix name). It can not take another value.
\item freq: frequency at which the fix is invoked (typically at every timestep). Values has to be integers.
\item EPS ratio: Ratio between outer-radius and inner-radius of the microbe. Value is typically floating number greater than 1.0.
\item EPS-density: Density of the EPS, required for the divisions of HET particles. Values can be floating type number.
\item Seed: Seed for the orientation and introduce the randomness, very large integer values. Same seed will result in the same orientation for every simulation run.
\end{itemize}


\section{Shoving algorithms}
Implementation of IB submodels often result in overlaps between the microbes. Resolution of these overlaps is necessary because of 2 reasons 1) Physical sub-models dealing with particle level physics are often based on the soft particle dynamics with minimum overlaps. 2) In natural conditions existing in microbial colonies, microbes would not overlap with each other. Previously shoving algorithms have been proposed in literature, iDynomics employ a relaxation algorithm that determines the steady-state microbial locations with the minimal number of overlaps. Pair-wise overlap is resolved by moving each agent by half the overlap distance. This approach can be computationally expensive and might require several iterations to resolve the overlaps. Present solver attempts to solve physics at the particle level, which require forces to be calculated based on instantaneous particle overlaps. Force equation is solved on each particle and assembly is evolved using Newton's laws of motion. LAMMPS solves the force equations and method as earlier discussed is called Discrete Element Method (DEM). The method works with soft particle force models (system modelled as particles linked with spring-dashpot system) where particles are allowed small overlaps (typically less than 1\% of their sizes). A pair-wise repulsive force is exerted on the particles as a function of the overlap and the relative velocities, resolving particle collisions. This dynamics can be controlled by using smaller particle time-steps if un-physically high overlaps are seen in the system. Introduction of IB sub-models can result is increasingly high particle overlaps, hence needing an algorithm to resolve the high overlaps without giving system un-physically high forces and velocities. 

\begin{enumerate}
\item Microbial growth: Microbes are represented as spherical masses with finite diameter and volume. As the microbial mass is added, volume and diameter of the particle increases. Overlap between the particles is calculated as the difference between the sum of radii and distance between their centres. Since the radii are increasing, an extra compensation has to be made to the particle centre coordinates in order to avoid high overlaps. Particle growth rate is usually much smaller than the collision times, hence overlaps due to particle growth models are expected to resolve by themselves. 

\item Microbial division: As the mother cells divides into 2 cells, orientation and the placement of these daughter cells can result into sudden and large overlaps. This might result in bad dynamics in the system. One of the ways is to check for the overlaps before inserting the cell into the position. However, re-building neighbour lists before inserting each particle can be computationally very expensive. 

\item EPS extraction: Similar to problem with the microbial division, placing extracted EPS particle at an appropriate location or resolving resulting large overlaps can be problematic. 
\end{enumerate} 

Apart from reducing timesteps, LAMMPS provides several options to resolve these overlaps. Any of these commands or LAMMPS functionality can be used. At present, test runs are being conducted to check the parameters and the optimization of the run time. These LAMMPS options are listed here: 

\begin{itemize}
\item Add a viscous damping force to atoms in the group that is proportional to the velocity of the atom. The added force can be thought of as a frictional interaction with implicit solvent, i.e. the no-slip Stokes drag on a spherical particle. This can be useful for draining the kinetic energy from the system in a controlled fashion. If used without additional thermostatting (to add kinetic energy to the system), it has the effect of slowly (or rapidly) freezing the system; hence it can also be used as a simple energy minimization technique. The damping force F is given by F = - gamma * velocity. The larger the coefficient, the faster the kinetic energy is reduced. A full description can be found \href{http://lammps.sandia.gov/doc/fix_viscous.html}{here}.

\item Perform  a constant NVE updates of position and velocity for atoms in the group each timestep. A limit is imposed on the maximum distance an atom can move per timestep. Normally large overlaps would generate huge forces which would blow atoms out of the simulation box, causing LAMMPS to stop with an error. This can be done by using limited time integrator, full description can be found \href{http://lammps.sandia.gov/doc/fix_nve_limit.html}{here}.

\item Using a pair-wise repulsive forces that would not blow up if particle overlaps. Description and implementation can be found \href{http://lammps.sandia.gov/doc/pair_soft.html}{here}.

\item Energy minimization: Perform an energy minimization of the system, by iteratively adjusting atom coordinates. Iterations are terminated when one of the stopping criteria is satisfied. At that point the configuration will hopefully be in local potential energy minimum. More precisely, the configuration should approximate a critical point for the objective function, which may or may not be a local minimum. This method allows to adjust the particle coordinates to minimize the energy, instead of completely resolving the overlaps as is the case with iDynomics. Description and implementation can be found \href{http://lammps.sandia.gov/doc/minimize.html}{here}.
\end{itemize} 

\section{Graphical User interface (GUI)}
Graphical user interface can be used to run the test case in place of the LAMMPS input script. However, it is strongly recommended to go through LAMMPS tutorials and user manuals before using the GUI. GUI summarizes the user input commands that are mostly required by the user. Some of the LAMMPS commands which are essential to run every case are not a part of GUI. GUI generates a LAMMPS input script based on user set options and this script can be check by the user and run accordingly. GUI source code (written using wxwidgets) and compilation instructions can be found at \href{https://github.com/darrenjw/nufeb/tree/master/code/gui}{Git-hub repository}. A snapshot of the GUI is shown in the figure \ref{fig:GUI}. 

\begin{figure}[H]
\begin{center}
  \includegraphics[width=0.9\columnwidth]{Figs/GUI.pdf}
\caption{Graphical User Interface (GUI) for NUFEB model}
\label{fig:GUI}       % Give a unique label
\end{center}
\end{figure}


\section{Visualization and post-processing}
LAMMPS can output snapshot file which gives information on the particle ids, positions, diameter etc at each timestep frequency as required by the user. Visualization tools often used in conjunction with LAMMPS are can be found \href{ http://lammps.sandia.gov/viz.html}{here}. POVray is more preferred visualization tool by the NUFEB project, the tool and compilation instructions can be found \href{http://www.povray.org/}{here}. Post processing tools to convert the LAMMPS format to POVray format can be found in the pizza python toolkits found \href{http://pizza.sandia.gov/}{here}. Scripts for post-processing of the LAMMPS data are under preparation. 


\label{References}
%\setlength{\bibsep}{3.0pt}
%\lhead{\emph{References}}  % Change the left side page header to "Bibliography"
%\rhead{\emph{References}}  % Change the left side page header to "Bibliography"
\small
%\begin{spacing}{0.9}
\bibliographystyle{Thesisnew}  % Use the "unsrtnat" BibTeX style for formatting the Bibliography
\bibliography{LAMMPS-Bio-Doc}  % The references (bibliography) information are stored in the file named "Bibliography.bib"
%\end{spacing}


\end{document}
